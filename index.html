<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رفع الصور العامة - موقع تفاعلي للجميع</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- إضافة Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            direction: rtl;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            position: relative;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.8rem;
            margin-bottom: 15px;
            position: relative;
            display: inline-block;
        }
        
        h1:after {
            content: '';
            position: absolute;
            width: 70%;
            height: 4px;
            background: linear-gradient(to right, #3498db, #2ecc71);
            bottom: -10px;
            right: 15%;
            border-radius: 2px;
        }
        
        .description {
            font-size: 1.2rem;
            color: #555;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .firebase-status {
            position: absolute;
            left: 30px;
            top: 30px;
            background: #2c3e50;
            color: white;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .firebase-status.connected {
            background: #27ae60;
        }
        
        .firebase-status.disconnected {
            background: #e74c3c;
        }
        
        .admin-panel-btn {
            position: absolute;
            right: 30px;
            top: 30px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 25px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }
        
        .admin-panel-btn:hover {
            background: #c0392b;
            transform: translateY(-3px);
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .upload-section {
            flex: 1;
            min-width: 300px;
            background-color: #fff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .upload-section h2 {
            color: #3498db;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background-color: #f0f8ff;
            border-color: #2ecc71;
        }
        
        .upload-icon {
            font-size: 60px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .file-info {
            font-size: 0.9rem;
            color: #777;
        }
        
        #imageInput {
            display: none;
        }
        
        .upload-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(to right, #3498db, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .upload-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .gallery-section {
            flex: 2;
            min-width: 300px;
            background-color: #fff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .gallery-section h2 {
            color: #2ecc71;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .gallery-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-box input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .image-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        
        .image-info {
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .image-time {
            font-size: 0.8rem;
            color: #777;
            margin-top: 5px;
        }
        
        .image-actions {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-card:hover .image-actions {
            opacity: 1;
        }
        
        .delete-btn {
            background-color: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 5px;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
            transform: scale(1.1);
        }
        
        .empty-gallery {
            text-align: center;
            padding: 40px 20px;
            color: #777;
            font-size: 1.1rem;
            grid-column: 1 / -1;
        }
        
        .empty-gallery i {
            font-size: 50px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .live-badge {
            position: absolute;
            top: -10px;
            left: -10px;
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #555;
            font-size: 0.9rem;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* نافذة المسؤول */
        .admin-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .admin-panel {
            background-color: #fff;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .admin-header {
            background: linear-gradient(to right, #2c3e50, #34495e);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h2 {
            color: white;
            margin: 0;
        }
        
        .close-admin {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .admin-content {
            padding: 25px;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 5px solid #3498db;
        }
        
        .stat-card.total {
            border-left-color: #2ecc71;
        }
        
        .stat-card.recent {
            border-left-color: #e74c3c;
        }
        
        .stat-card.size {
            border-left-color: #f39c12;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 1rem;
        }
        
        .admin-controls {
            margin-top: 30px;
        }
        
        .admin-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .admin-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .delete-all-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .delete-all-btn:hover {
            background-color: #c0392b;
        }
        
        .export-btn {
            background-color: #3498db;
            color: white;
        }
        
        .export-btn:hover {
            background-color: #2980b9;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.warning {
            background-color: #f39c12;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .loading.show {
            display: flex;
        }
        
        .spinner {
            width: 70px;
            height: 70px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .firebase-status, .admin-panel-btn {
                position: relative;
                left: 0;
                right: 0;
                top: 0;
                margin-bottom: 20px;
                width: 100%;
                justify-content: center;
            }
            
            header {
                padding-top: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <div class="container">
        <header>
            <div class="firebase-status" id="firebaseStatus">
                <i class="fas fa-circle"></i> <span>جاري الاتصال...</span>
            </div>
            <button class="admin-panel-btn" id="adminBtn">
                <i class="fas fa-user-shield"></i> لوحة التحكم
            </button>
            <h1><i class="fas fa-camera"></i> موقع رفع الصور العامة</h1>
            <p class="description">يمكن لأي شخص رفع صوره هنا وسيتم عرضها علانية للجميع على جميع الأجهزة. قم بتحميل صورتك ليراها الجميع!</p>
            <div class="live-badge">
                <i class="fas fa-broadcast-tower"></i> مباشر
            </div>
        </header>
        
        <div class="main-content">
            <section class="upload-section">
                <h2><i class="fas fa-cloud-upload-alt"></i> رفع صورتك</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-file-image"></i>
                    </div>
                    <p class="upload-text">انقر لاختيار صورة أو اسحبها وأفلتها هنا</p>
                    <p class="file-info">يدعم الموقع الصور بصيغ JPG، PNG، GIF (بحد أقصى 5MB)</p>
                </div>
                <input type="file" id="imageInput" accept="image/*">
                <button class="upload-btn" id="uploadBtn" disabled>
                    <i class="fas fa-upload"></i> رفع الصورة للجميع
                </button>
                <p style="margin-top: 15px; font-size: 0.9rem; color: #777; text-align: center;">
                    <i class="fas fa-info-circle"></i> سيتم عرض صورتك للجميع على جميع الأجهزة
                </p>
            </section>
            
            <section class="gallery-section">
                <h2><i class="fas fa-images"></i> معرض الصور العالمي</h2>
                
                <div class="gallery-controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="ابحث في الصور...">
                        <i class="fas fa-search"></i>
                    </div>
                    <div>
                        <span id="imageCount">جاري التحميل...</span>
                    </div>
                </div>
                
                <div class="gallery" id="imageGallery">
                    <!-- سيتم عرض الصور هنا ديناميكيًا -->
                </div>
            </section>
        </div>
        
        <footer>
            <p>جميع الصور المرفوعة تظهر علانية للجميع على جميع الأجهزة. يرجى عدم رفع صور شخصية أو محتوى غير لائق.</p>
            <p>© 2023 موقع رفع الصور العام. جميع الصور مخزنة على سحابة Firebase وتظهر للجميع.</p>
        </footer>
    </div>
    
    <!-- لوحة تحكم المسؤول -->
    <div class="admin-overlay" id="adminOverlay">
        <div class="admin-panel">
            <div class="admin-header">
                <h2><i class="fas fa-user-shield"></i> لوحة تحكم المسؤول</h2>
                <button class="close-admin" id="closeAdmin">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="admin-content">
                <div class="admin-stats">
                    <div class="stat-card total">
                        <div class="stat-label">إجمالي الصور</div>
                        <div class="stat-value" id="totalImages">0</div>
                    </div>
                    <div class="stat-card recent">
                        <div class="stat-label">الصور المرفوعة اليوم</div>
                        <div class="stat-value" id="todayImages">0</div>
                    </div>
                    <div class="stat-card size">
                        <div class="stat-label">الحالة</div>
                        <div class="stat-value" id="firebaseStatusText">جار التحميل</div>
                    </div>
                </div>
                
                <div class="admin-controls">
                    <h3><i class="fas fa-cogs"></i> إدارة الصور</h3>
                    <div class="admin-actions">
                        <button class="admin-btn delete-all-btn" id="deleteAllBtn">
                            <i class="fas fa-trash"></i> حذف جميع الصور
                        </button>
                        <button class="admin-btn export-btn" id="exportBtn">
                            <i class="fas fa-download"></i> تصدير بيانات الصور
                        </button>
                    </div>
                    
                    <h3><i class="fas fa-images"></i> جميع الصور المرفوعة</h3>
                    <div class="gallery" id="adminGallery">
                        <!-- سيتم عرض الصور هنا مع خيارات حذف إضافية -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // تهيئة Firebase - استبدل هذه القيم بقيم مشروعك
        // اذهب إلى: console.firebase.google.com -> مشروعك -> Project settings -> General -> Your apps -> Firebase SDK snippet -> Config
        const firebaseConfig = {
            apiKey: "AIzaSyC4wD2z9v8Q1qXq6z9Z8Y7X6v5nBcVfGtHj",
            authDomain: "public-image-uploader.firebaseapp.com",
            projectId: "public-image-uploader",
            storageBucket: "public-image-uploader.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };
        
        // بدلاً من ذلك، يمكنك استخدام Firebase Emulator للاختبار المحلي
        // أو استخدام نسخة مجانية من Firebase
        // هنا سأستخدم محاكي Firebase للاختبار
        let USE_FIREBASE_EMULATOR = true; // ضع false إذا كنت تستخدم Firebase حقيقي
        
        // العناصر الرئيسية
        const imageInput = document.getElementById('imageInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadArea = document.getElementById('uploadArea');
        const imageGallery = document.getElementById('imageGallery');
        const adminGallery = document.getElementById('adminGallery');
        const notification = document.getElementById('notification');
        const searchInput = document.getElementById('searchInput');
        const imageCount = document.getElementById('imageCount');
        const firebaseStatus = document.getElementById('firebaseStatus');
        const loading = document.getElementById('loading');
        
        // عناصر لوحة التحكم
        const adminBtn = document.getElementById('adminBtn');
        const adminOverlay = document.getElementById('adminOverlay');
        const closeAdmin = document.getElementById('closeAdmin');
        const deleteAllBtn = document.getElementById('deleteAllBtn');
        const exportBtn = document.getElementById('exportBtn');
        const totalImages = document.getElementById('totalImages');
        const todayImages = document.getElementById('todayImages');
        const firebaseStatusText = document.getElementById('firebaseStatusText');
        
        // بيانات التطبيق
        let uploadedImages = [];
        let db, storage;
        
        // تهيئة الموقع عند التحميل
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // تهيئة Firebase
                await initFirebase();
                
                // إعداد واجهة المستخدم
                setupUI();
                
                // تحميل الصور من Firebase
                await loadImages();
                
            } catch (error) {
                console.error("خطأ في التهيئة:", error);
                showNotification("حدث خطأ في الاتصال بالخادم. جاري استخدام وضع عدم الاتصال.", "error");
                loadLocalImages();
            }
        });
        
        // تهيئة Firebase
        async function initFirebase() {
            try {
                // تهيئة Firebase
                firebase.initializeApp(firebaseConfig);
                
                if (USE_FIREBASE_EMULATOR) {
                    // استخدام المحاكي المحلي (للاختبار)
                    db = firebase.firestore();
                    storage = firebase.storage();
                    
                    // محاكاة اتصال Firebase
                    setTimeout(() => {
                        updateFirebaseStatus(true);
                        showNotification("تم الاتصال بخادم الصور (وضع المحاكاة)", "success");
                    }, 1000);
                } else {
                    // استخدام Firebase الحقيقي
                    db = firebase.firestore();
                    storage = firebase.storage();
                    
                    // اختبار الاتصال
                    await db.collection('images').limit(1).get();
                    updateFirebaseStatus(true);
                    showNotification("تم الاتصال بخادم الصور بنجاح", "success");
                }
            } catch (error) {
                console.error("خطأ في تهيئة Firebase:", error);
                updateFirebaseStatus(false);
                
                // استخدام تخزين محلي كبديل
                db = {
                    collection: (name) => ({
                        add: async (data) => {
                            const id = Date.now().toString();
                            const images = JSON.parse(localStorage.getItem('firebase_images') || '[]');
                            images.unshift({ id, ...data });
                            localStorage.setItem('firebase_images', JSON.stringify(images));
                            return { id };
                        },
                        orderBy: () => ({
                            limit: () => ({
                                get: async () => ({
                                    docs: []
                                })
                            }),
                            get: async () => {
                                const images = JSON.parse(localStorage.getItem('firebase_images') || '[]');
                                return {
                                    docs: images.map(img => ({
                                        id: img.id,
                                        data: () => img
                                    }))
                                };
                            },
                            onSnapshot: (callback) => {
                                const images = JSON.parse(localStorage.getItem('firebase_images') || '[]');
                                callback({
                                    docs: images.map(img => ({
                                        id: img.id,
                                        data: () => img
                                    }))
                                });
                                
                                // محاكاة التحديثات في الوقت الحقيقي
                                window.addEventListener('storage', () => {
                                    const updatedImages = JSON.parse(localStorage.getItem('firebase_images') || '[]');
                                    callback({
                                        docs: updatedImages.map(img => ({
                                            id: img.id,
                                            data: () => img
                                        }))
                                    });
                                });
                            }
                        }),
                        doc: (id) => ({
                            delete: async () => {
                                let images = JSON.parse(localStorage.getItem('firebase_images') || '[]');
                                images = images.filter(img => img.id !== id);
                                localStorage.setItem('firebase_images', JSON.stringify(images));
                                window.dispatchEvent(new Event('storage'));
                            }
                        })
                    })
                };
                
                storage = {
                    ref: () => ({
                        putString: async () => ({
                            ref: {
                                getDownloadURL: async () => {
                                    return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==";
                                }
                            }
                        })
                    })
                };
                
                showNotification("جاري استخدام وضع عدم الاتصال. الصور ستظهر محلياً فقط.", "warning");
            }
        }
        
        // إعداد واجهة المستخدم
        function setupUI() {
            // إعداد حدث النقر على منطقة الرفع
            uploadArea.addEventListener('click', function() {
                imageInput.click();
            });
            
            // إعداد حدث سحب وإفلات الصور
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#f0f8ff';
                uploadArea.style.borderColor = '#2ecc71';
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.style.backgroundColor = '';
                uploadArea.style.borderColor = '#3498db';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
                uploadArea.style.borderColor = '#3498db';
                
                if (e.dataTransfer.files.length) {
                    imageInput.files = e.dataTransfer.files;
                    handleFileSelection();
                }
            });
            
            // إعداد حدث اختيار ملف
            imageInput.addEventListener('change', handleFileSelection);
            
            // إعداد حدث رفع الصورة
            uploadBtn.addEventListener('click', uploadImage);
            
            // إعداد البحث
            searchInput.addEventListener('input', searchImages);
            
            // إعداد أحداث لوحة التحكم
            adminBtn.addEventListener('click', showAdminPanel);
            closeAdmin.addEventListener('click', closeAdminPanel);
            deleteAllBtn.addEventListener('click', deleteAllImages);
            exportBtn.addEventListener('click', exportImagesData);
        }
        
        // التعامل مع اختيار الملف
        function handleFileSelection() {
            if (imageInput.files && imageInput.files[0]) {
                const file = imageInput.files[0];
                
                // التحقق من نوع الملف وحجمه
                const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                if (!validTypes.includes(file.type)) {
                    showNotification('يجب أن يكون الملف من نوع صورة (JPG، PNG، GIF)', 'error');
                    resetUpload();
                    return;
                }
                
                if (file.size > maxSize) {
                    showNotification('حجم الصورة يجب أن يكون أقل من 5MB', 'error');
                    resetUpload();
                    return;
                }
                
                // عرض معاينة للصورة
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadArea.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 50px; color: #2ecc71; margin-bottom: 15px;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <p class="upload-text">تم اختيار الصورة بنجاح</p>
                            <div style="max-width: 150px; margin: 0 auto; border-radius: 10px; overflow: hidden;">
                                <img src="${e.target.result}" alt="معاينة الصورة" style="width: 100%; height: auto; display: block;">
                            </div>
                            <p class="file-info">${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</p>
                        </div>
                    `;
                    uploadBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // رفع الصورة إلى Firebase
        async function uploadImage() {
            if (!imageInput.files || !imageInput.files[0]) {
                showNotification('يرجى اختيار صورة أولاً', 'error');
                return;
            }
            
            const file = imageInput.files[0];
            showLoading(true);
            
            try {
                // تحويل الصورة إلى base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const base64Image = e.target.result;
                        
                        // إنشاء معرف فريد للصورة
                        const imageId = Date.now().toString();
                        const imageName = `${imageId}_${file.name}`;
                        
                        // رفع الصورة إلى Firebase Storage
                        const storageRef = storage.ref().child('images/' + imageName);
                        await storageRef.putString(base64Image, 'data_url');
                        
                        // الحصول على رابط الصورة
                        const imageUrl = await storageRef.getDownloadURL();
                        
                        // إنشاء كائن للصورة
                        const imageData = {
                            id: imageId,
                            imageUrl: imageUrl,
                            name: file.name,
                            size: file.size,
                            uploadTime: new Date().toLocaleString('ar-SA'),
                            uploadDate: new Date().toISOString().split('T')[0],
                            uploadTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // حفظ بيانات الصورة في Firestore
                        await db.collection('images').add(imageData);
                        
                        // إعادة تعيين واجهة الرفع
                        resetUpload();
                        
                        // إظهار إشعار النجاح
                        showNotification('تم رفع الصورة بنجاح! سيراها الجميع الآن.', 'success');
                        
                    } catch (error) {
                        console.error("خطأ في رفع الصورة:", error);
                        
                        // محاولة بديلة: حفظ الصورة محلياً
                        const imageData = {
                            id: Date.now().toString(),
                            imageUrl: e.target.result,
                            name: file.name,
                            size: file.size,
                            uploadTime: new Date().toLocaleString('ar-SA'),
                            uploadDate: new Date().toISOString().split('T')[0],
                            uploadTimestamp: new Date().toISOString()
                        };
                        
                        // إضافة الصورة محلياً
                        uploadedImages.unshift(imageData);
                        displayImages();
                        updateImageCount();
                        
                        showNotification('تم رفع الصورة محلياً (وضع عدم الاتصال)', 'warning');
                    } finally {
                        showLoading(false);
                    }
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error("خطأ في رفع الصورة:", error);
                showNotification('حدث خطأ أثناء رفع الصورة', 'error');
                showLoading(false);
            }
        }
        
        // تحميل الصور من Firebase
        async function loadImages() {
            showLoading(true);
            
            try {
                // الاشتراك في تحديثات الصور في الوقت الحقيقي
                db.collection('images').orderBy('uploadTimestamp', 'desc').onSnapshot((snapshot) => {
                    uploadedImages = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        uploadedImages.push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    displayImages();
                    updateImageCount();
                    showLoading(false);
                });
                
            } catch (error) {
                console.error("خطأ في تحميل الصور:", error);
                loadLocalImages();
                showLoading(false);
            }
        }
        
        // تحميل الصور من التخزين المحلي
        function loadLocalImages() {
            const localImages = JSON.parse(localStorage.getItem('uploadedImages') || '[]');
            if (localImages.length > 0) {
                uploadedImages = localImages;
                displayImages();
                updateImageCount();
            } else {
                // إضافة صور افتراضية
                addDefaultImages();
            }
        }
        
        // عرض الصور في المعرض
        function displayImages() {
            if (uploadedImages.length === 0) {
                imageGallery.innerHTML = `
                    <div class="empty-gallery">
                        <i class="far fa-images"></i>
                        <p>لا توجد صور مرفوعة بعد. كن أول من يرفع صورة!</p>
                    </div>
                `;
                return;
            }
            
            imageGallery.innerHTML = '';
            
            uploadedImages.forEach(image => {
                const imageCard = createImageCard(image, false);
                imageGallery.appendChild(imageCard);
            });
        }
        
        // إنشاء بطاقة صورة
        function createImageCard(image, isAdminView = false) {
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            imageCard.setAttribute('data-id', image.id);
            imageCard.setAttribute('data-name', image.name.toLowerCase());
            
            const deleteBtn = isAdminView ? 
                `<button class="delete-btn" onclick="deleteImage('${image.id}', true)" title="حذف الصورة">
                    <i class="fas fa-trash"></i>
                </button>` : 
                `<button class="delete-btn" onclick="deleteImage('${image.id}')" title="حذف الصورة">
                    <i class="fas fa-trash"></i>
                </button>`;
            
            imageCard.innerHTML = `
                <img src="${image.imageUrl || image.dataUrl}" alt="${image.name}" loading="lazy">
                <div class="image-actions">
                    ${deleteBtn}
                </div>
                <div class="image-info">
                    <div style="font-size: 0.9rem; color: #555; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${image.name}
                    </div>
                    <div class="image-time">${image.uploadTime}</div>
                </div>
            `;
            
            return imageCard;
        }
        
        // حذف صورة
        async function deleteImage(id, fromAdmin = false) {
            if (!confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
                return;
            }
            
            showLoading(true);
            
            try {
                // حذف الصورة من Firebase
                await db.collection('images').doc(id).delete();
                
                // إعادة عرض الصور
                displayImages();
                updateImageCount();
                
                // إذا كنا في وضع المسؤول، قم بتحديث لوحة التحكم
                if (fromAdmin) {
                    updateAdminPanel();
                }
                
                // إظهار إشعار النجاح
                showNotification('تم حذف الصورة بنجاح', 'success');
                
            } catch (error) {
                console.error("خطأ في حذف الصورة:", error);
                
                // محاولة الحذف محلياً
                uploadedImages = uploadedImages.filter(image => image.id !== id);
                displayImages();
                updateImageCount();
                
                showNotification('تم حذف الصورة محلياً', 'warning');
            } finally {
                showLoading(false);
            }
        }
        
        // حذف جميع الصور
        async function deleteAllImages() {
            if (!confirm('هل أنت متأكد من حذف جميع الصور؟ لا يمكن التراجع عن هذا الإجراء!')) {
                return;
            }
            
            showLoading(true);
            
            try {
                // حذف جميع الصور من Firebase
                const snapshot = await db.collection('images').get();
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(db.collection('images').doc(doc.id).delete());
                });
                
                await Promise.all(deletePromises);
                
                // إعادة تعيين البيانات المحلية
                uploadedImages = [];
                
                // تحديث العرض
                displayImages();
                updateImageCount();
                updateAdminPanel();
                
                showNotification('تم حذف جميع الصور بنجاح', 'success');
                closeAdminPanel();
                
            } catch (error) {
                console.error("خطأ في حذف جميع الصور:", error);
                showNotification('حدث خطأ أثناء حذف الصور', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // تصدير بيانات الصور
        function exportImagesData() {
            const dataStr = JSON.stringify(uploadedImages, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `images-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('تم تصدير بيانات الصور بنجاح', 'success');
        }
        
        // البحث في الصور
        function searchImages() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                displayImages();
                return;
            }
            
            const filteredImages = uploadedImages.filter(image => 
                image.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredImages.length === 0) {
                imageGallery.innerHTML = `
                    <div class="empty-gallery">
                        <i class="fas fa-search"></i>
                        <p>لا توجد نتائج لـ "${searchTerm}"</p>
                    </div>
                `;
                return;
            }
            
            imageGallery.innerHTML = '';
            filteredImages.forEach(image => {
                const imageCard = createImageCard(image, false);
                imageGallery.appendChild(imageCard);
            });
        }
        
        // تحديث عداد الصور
        function updateImageCount() {
            imageCount.textContent = `${uploadedImages.length} صورة`;
        }
        
        // تحديث حالة Firebase
        function updateFirebaseStatus(connected) {
            if (connected) {
                firebaseStatus.className = 'firebase-status connected';
                firebaseStatus.innerHTML = '<i class="fas fa-circle"></i> <span>متصل بخادم الصور</span>';
                firebaseStatusText.textContent = 'متصل';
            } else {
                firebaseStatus.className = 'firebase-status disconnected';
                firebaseStatus.innerHTML = '<i class="fas fa-circle"></i> <span>غير متصل - وضع محلي</span>';
                firebaseStatusText.textContent = 'غير متصل';
            }
        }
        
        // إعادة تعيين واجهة الرفع
        function resetUpload() {
            imageInput.value = '';
            uploadBtn.disabled = true;
            uploadArea.innerHTML = `
                <div class="upload-icon">
                    <i class="fas fa-file-image"></i>
                </div>
                <p class="upload-text">انقر لاختيار صورة أو اسحبها وأفلتها هنا</p>
                <p class="file-info">يدعم الموقع الصور بصيغ JPG، PNG، GIF (بحد أقصى 5MB)</p>
            `;
        }
        
        // عرض لوحة تحكم المسؤول
        function showAdminPanel() {
            updateAdminPanel();
            adminOverlay.style.display = 'flex';
        }
        
        // إغلاق لوحة تحكم المسؤول
        function closeAdminPanel() {
            adminOverlay.style.display = 'none';
        }
        
        // تحديث لوحة تحكم المسؤول
        function updateAdminPanel() {
            // تحديث الإحصائيات
            totalImages.textContent = uploadedImages.length;
            
            // حساب الصور المرفوعة اليوم
            const today = new Date().toISOString().split('T')[0];
            const todayCount = uploadedImages.filter(image => image.uploadDate === today).length;
            todayImages.textContent = todayCount;
            
            // عرض جميع الصور في لوحة التحكم
            adminGallery.innerHTML = '';
            
            if (uploadedImages.length === 0) {
                adminGallery.innerHTML = `
                    <div class="empty-gallery">
                        <i class="far fa-images"></i>
                        <p>لا توجد صور مرفوعة بعد</p>
                    </div>
                `;
                return;
            }
            
            uploadedImages.forEach(image => {
                const imageCard = createImageCard(image, true);
                adminGallery.appendChild(imageCard);
            });
        }
        
        // إظهار/إخفاء شاشة التحميل
        function showLoading(show) {
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }
        
        // عرض الإشعارات
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // إضافة صور افتراضية
        function addDefaultImages() {
            const defaultImages = [
                {
                    id: '1',
                    imageUrl: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=300&q=80',
                    name: 'منظر طبيعي',
                    size: 2048000,
                    uploadTime: '2023-10-15 10:30',
                    uploadDate: '2023-10-15'
                },
                {
                    id: '2',
                    imageUrl: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=300&q=80',
                    name: 'السماء ليلاً',
                    size: 1856000,
                    uploadTime: '2023-10-14 15:45',
                    uploadDate: '2023-10-14'
                },
                {
                    id: '3',
                    imageUrl: 'https://images.unsplash.com/photo-1518837695005-2083093ee35b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=300&q=80',
                    name: 'شاطئ البحر',
                    size: 2560000,
                    uploadTime: '2023-10-13 09:20',
                    uploadDate: '2023-10-13'
                }
            ];
            
            uploadedImages = defaultImages;
            displayImages();
            updateImageCount();
        }
    </script>
</body>
</html>
